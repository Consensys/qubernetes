<%-

@Geth_WS = false
if @config["k8s"] and @config["k8s"]["service"]["Ingress"] then
   @Ingress = true
   # OneForAll
   @IngressStrategy = @config["k8s"]["service"]["Ingress"]["Strategy"]
   if @config["k8s"]["service"]["Ingress"]["Host"]  then
     @Ingress_Host = @config["k8s"]["service"]["Ingress"]["Host"]
   end
   if @config["k8s"]["service"]["Ingress"]["ws"]  then
     @Geth_WS = true
   end
  @Ingress_Annotations = []
  if @config["k8s"]["service"]["Ingress"]["annotations"]
    @Ingress_Annotations = @config["k8s"]["service"]["Ingress"]["annotations"]
  end
  @Ingress_tls_secret_name = ""
  if @config["k8s"]["service"]["Ingress"]["tls"] and @config["k8s"]["service"]["Ingress"]["tls"]["secretName"]
    @Ingress_tls_secret_name = @config["k8s"]["service"]["Ingress"]["tls"]["secretName"]
  end
end
-%>

<%# Strategy OneToOne - this will create one Ingress per node service in the cluster %>
<%# in this strategy each node will get its own FQDN with the nodeId as the first part of the domain %>
<%- if @Ingress and @IngressStrategy == "OneToOne" -%>
<%- @nodes.each do |node| -%>
<%= set_node_template_vars(node) -%>

---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
    <%= @Namespace %>
  name: "<%= @Node_UserIdent %>"
  <%- if ! @Ingress_Annotations.empty? -%>
  annotations:
  <%- @Ingress_Annotations.each do |entry| -%>
    <%= entry[0] %>: "<%= entry[1] %>"
  <%- end -%>
  <%- end -%>
spec:
  rules:
      <%- if @Ingress_Host -%>
    - host:  "<%= @Node_UserIdent %>.<%= @Ingress_Host %>"
      http:
        paths:
          - path: /quorum-rpc
            pathType: Prefix
            backend:
              service:
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_RPCPort %>
          <%- if  @Geth_WS -%>
          - path: /quorum-ws
            pathType: Prefix
            backend:
              service:
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_WSPort %>
          <%- end -%>
  tls:
    - hosts:
        - "<%= @Node_UserIdent %>.<%= @Ingress_Host %>"
      <%- if ! @Ingress_tls_secret_name.empty? -%>
      secretName: <%= @Ingress_tls_secret_name %>
      <%- end -%>
      <%- else -%>
    - http:
        paths:
          - path: /quorum-rpc
            pathType: Prefix
            backend:
              service:
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_RPCPort %>
          <%- if  @Geth_WS -%>
          - path: /quorum-ws
            pathType: Prefix
            backend:
              service:
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_WSPort %>
          <%- end -%>
        <%- end -%> <%# End Host conditional %>
     <% end -%> <%# end this node iteration %>
<%- end -%> <%# End Ingress OneForEach (this node's ingress) %>



<%# If an ingresses has been specified with strategy OneToMany, create a single Ingress for all the nodes in the cluster %>
<% if @Ingress and @IngressStrategy == "OneToMany" %>
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
    <%= @Namespace %>
  name: quorum-ingress
  <%- if ! @Ingress_Annotations.empty? -%>
  annotations:
  <%- @Ingress_Annotations.each do |entry| -%>
    <%= entry[0] %>: "<%= entry[1] %>"
  <%- end -%>
  <%- end -%>
spec:
  rules:
      <%- if @Ingress_Host -%>
    - host: "<%= @Ingress_Host %>"
      http:
      <%- else -%>
    - http:
     <%- end -%> <%# end  Host conditional%>
        paths:
         <%- # create paths for each node -%>
         <%- @nodes.each do |node| -%>
            <%- set_node_template_vars(node) -%>
          - path: /<%= @Node_UserIdent %>/quorum-rpc
            backend:
              service
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_RPCPort %>
          <%- if  @Geth_WS -%>
          - path: /<%= @Node_UserIdent %>/quorum-ws
            backend:
              service
                name: <%= @Node_UserIdent %>
              port:
                number <%= @Node_WSPort %>
          <%- end -%>
         <%- end -%> <%# end setting path for each node %>
 <%- if @Ingress_Host -%>
  tls:
    - hosts:
        - "<%= @Ingress_Host %>"
      <%- if ! @Ingress_tls_secret_name.empty? -%>
      secretName: <%= @Ingress_tls_secret_name %>
      <%- end -%>
 <%- end -%>
<%- end %> <%# end  Ingress conditional%>
